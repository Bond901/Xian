<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- 關鍵！解決 iPhone 真機側邊欄消失與底部被蓋問題 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>仙 Xian - 養生特調 Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #0f0f0f;
            margin: 0;
            padding: 0;
            min-height: 100dvh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
        }
        
        html { height: -webkit-fill-available; }

        #kiosk-container {
            width: 100%;
            min-height: 100dvh;
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            padding: max(var(--safe-top), 1rem) max(var(--safe-left), 0px) 0 max(var(--safe-right), 0px);
        }

        @media (min-width: 768px) {
            #kiosk-container {
                height: 94dvh;
                min-height: 800px;
                margin: 2dvh auto;
                border: 8px solid #1c1917;
                border-radius: 24px;
                overflow: hidden;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                grid-template-columns: 360px 1fr;
                grid-template-rows: 1fr;
                padding: 0;
            }
        }

        /* 左側總結面板 */
        #summary-panel {
            background: #1c1917;
            color: white;
            padding: 1.5rem;
            padding-top: max(2rem, calc(var(--safe-top) + 1rem));
            padding-bottom: max(2rem, calc(var(--safe-bottom) + 1rem));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 主內容區 */
        #main-content-area {
            padding: 1.5rem;
            padding-bottom: calc(160px + var(--safe-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (min-width: 768px) {
            #main-content-area { padding: 2rem; padding-bottom: 2rem; }
        }

        /* 手機專用固定底部欄 */
        #mobile-footer {
            position: fixed;
            left: max(var(--safe-left), 0px);
            right: max(var(--safe-right), 0px);
            bottom: max(var(--safe-bottom), 0px);
            background: #1c1917;
            padding: 1rem;
            padding-bottom: calc(1rem + var(--safe-bottom));
            z-index: 9999;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.3);
            border-top: 1px solid #334155;
        }

        @media (min-width: 768px) {
            #mobile-footer { display: none !important; }
        }

        .step-indicator { transition: all 0.3s ease; }
        .step-indicator.active { 
            background: #059669; color: white; 
            transform: scale(1.12); box-shadow: 0 4px 15px rgba(5,150,105,0.4);
        }
        .choice-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid transparent;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .choice-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(5,150,105,0.25); }
        .choice-card.selected { 
            border-color: #10b981; 
            transform: scale(1.04);
            box-shadow: 0 0 0 4px rgba(16,185,129,0.2);
        }
        .material-image {
            height: 220px;
            width: 100%;
            object-fit: cover;
        }
        .quantity-btn {
            width: 72px; height: 72px;
            border-radius: 50%;
            font-size: 42px;
            font-weight: bold;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="flex items-center justify-center">

<div id="kiosk-container" class="rounded-3xl overflow-hidden">

    <!-- 左側總結面板 -->
    <div id="summary-panel" class="flex flex-col">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-emerald-800">
            <h3 class="text-2xl font-black text-emerald-400">您的養生特調</h3>
            <button id="view-cart-btn" class="bg-sky-600 hover:bg-sky-700 px-5 py-3 rounded-full font-bold transition shadow-lg">
                購物車 (<span id="cart-count">0</span>)
            </button>
        </div>

        <div id="material-intro" class="mb-6 bg-stone-800/70 backdrop-blur p-5 rounded-2xl text-sm border border-emerald-900">
            <p class="text-emerald-300 font-bold mb-2">物料介紹：</p>
            <p id="intro-text" class="text-stone-200 leading-relaxed">請點選開始製作您的養生飲品</p>
        </div>

        <div class="space-y-4 text-sm flex-grow">
            <p><span class="text-emerald-300 font-bold">基底：</span> <span id="summary-base">未選</span></p>
            <p><span class="text-emerald-300 font-bold">配料：</span> <span id="summary-topping">無</span></p>
            <p><span class="text-emerald-300 font-bold">冰量：</span> <span id="summary-ice">未選</span></p>
            <p><span class="text-emerald-300 font-bold">甜度：</span> <span id="summary-sweetener">無糖 (標配)</span></p>
            <p><span class="text-emerald-300 font-bold">數量：</span> <span id="summary-quantity">1</span> 杯</p>
        </div>

        <div class="hidden md:block mt-8 pt-6 border-t border-emerald-800">
            <div class="flex justify-between items-center mb-4">
                <span class="text-2xl font-bold">總計金額</span>
                <span id="total-price-desktop" class="text-5xl font-black text-emerald-400">NT$ 0</span>
            </div>
            <button id="next-step-btn-desktop" class="w-full py-5 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white text-2xl font-black transition shadow-2xl" disabled>
                下一步
            </button>
        </div>
    </div>

    <!-- 主內容區 -->
    <div id="main-content-area">
        <header class="mb-8">
            <h1 class="text-5xl md:text-6xl font-black text-emerald-700 mb-6">仙 · 養生特調</h1>
            <div class="flex flex-wrap gap-3">
                <span id="step-1-ind" class="step-indicator px-5 py-3 rounded-full bg-emerald-700 text-white active text-lg font-bold">1. 基底</span>
                <span id="step-2-ind" class="step-indicator px-5 py-3 rounded-full bg-stone-400 text-white text-lg font-bold">2. 配料</span>
                <span id="step-3-ind" class="step-indicator px-5 py-3 rounded-full bg-stone-400 text-white text-lg font-bold">3. 冰量</span>
                <span id="step-4-ind" class="step-indicator px-5 py-3 rounded-full bg-stone-400 text-white text-lg font-bold">4. 甜度</span>
            </div>
        </header>

        <div id="selection-area" class="flex-grow"></div>
    </div>
</div>

<!-- 手機底部固定欄 -->
<div id="mobile-footer" class="md:hidden text-white">
    <div class="flex justify-between items-center mb-3">
        <span class="text-2xl font-bold">總計金額</span>
        <span id="total-price-mobile" class="text-4xl font-black text-emerald-400">NT$ 0</span>
    </div>
    <button id="next-step-btn-mobile" class="w-full py-5 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white text-2xl font-black transition shadow-2xl" disabled>
        下一步
    </button>
</div>

<script>
    // 資料庫（使用高畫質實拍圖）
    const Materials = { base: [
        {id:'jasmine',name:'茉莉綠茶',price:60,intro:'清香回甘，提神醒腦',img:'https://images.unsplash.com/photo-1571934811356-5cc061b6821f?w=800'},
        {id:'oolong',name:'高山烏龍',price:65,intro:'醇厚甘潤，助消化',img:'https://images.unsplash.com/photo-1570194061610-557d2b7e8ec9?w=800'},
        {id:'sparkling',name:'氣泡水',price:70,intro:'零熱量清爽基底',img:'https://images.unsplash.com/photo-1557177324-56c542165309?w=800'},
        {id:'plum_wine',name:'養生梅酒',price:150,intro:'夜間限定，微醺養顏',img:'https://images.unsplash.com/photo-1516591733114-962a31c103b9?w=800',type:'夜酒'}
    ], topping: [
        {id:'ginseng',name:'人蔘片',price:30,intro:'補氣養神，珍稀聖品',img:'https://images.unsplash.com/photo-1615485737390-06e3c8f0c9b1?w=800',healthy:true},
        {id:'red_date',name:'紅棗',price:20,intro:'補血安神',img:'https://images.unsplash.com/photo-1571571734590-46c2e6e0b3d6?w=800',healthy:true},
        {id:'pearl',name:'手工珍珠',price:10,intro:'Q彈經典',img:'https://images.unsplash.com/photo-1550518068-3297a5c32fb9?w=800'},
        {id:'aloe',name:'蘆薈丁',price:15,intro:'清脆低卡',img:'https://images.unsplash.com/photo-1622801233-28d2993e5c63?w=800',healthy:true}
    ], sweetener: [
        {id:'none',name:'無糖 (標配)',price:0,intro:'健康首選，保留原味',img:'https://images.unsplash.com/photo-1519985176271-0d5d22f1e49c?w=800'},
        {id:'honey',name:'天然蜂蜜',price:15,intro:'純天然甜味',img:'https://images.unsplash.com/photo-1558648472-16f01ae9d8dc?w=800'},
        {id:'cane_sugar',name:'手炒蔗糖',price:10,intro:'香氣濃郁',img:'https://images.unsplash.com/photo-1606890737729-82d9ef7a18e0?w=800'}
    ]};
    const IceOptions = [
        {id:'hot',name:'熱飲',intro:'暖心暖胃'},
        {id:'warm',name:'溫飲',intro:'保護腸胃'},
        {id:'less',name:'少冰',intro:'微涼不刺激'},
        {id:'micro',name:'微冰',intro:'保留茶香'},
        {id:'normal',name:'正常冰',intro:'經典冰涼'}
    ];
    Materials.ice = IceOptions;

    let cart = [];
    let state = { step: 1, qty: 1, base: null, topping: null, ice: null, sugar: null };

    const el = {
        area: document.getElementById('selection-area'),
        intro: document.getElementById('intro-text'),
        summary: {
            base: document.getElementById('summary-base'),
            topping: document.getElementById('summary-topping'),
            ice: document.getElementById('summary-ice'),
            sugar: document.getElementById('summary-sweetener'),
            qty: document.getElementById('summary-quantity')
        },
        price: { d: document.getElementById('total-price-desktop'), m: document.getElementById('total-price-mobile') },
        btn: { d: document.getElementById('next-step-btn-desktop'), m: document.getElementById('next-step-btn-mobile') },
        cartCount: document.getElementById('cart-count'),
        steps: document.querySelectorAll('.step-indicator')
    };

    const updateUI = () => {
        el.steps.forEach((s,i) => {
            s.className = 'step-indicator px-5 py-3 rounded-full transition-all font-bold text-lg';
            if (i+1 < state.step) s.classList.add('bg-emerald-800','text-white');
            else if (i+1 === state.step) s.classList.add('bg-emerald-600','text-white','active');
            else s.classList.add('bg-stone-500','text-white');
        });

        let p = (state.base?.price||0) + (state.topping?.price||0) + (state.sugar?.price||0);
        el.summary.base.textContent = state.base ? `${state.base.name} (NT$${state.base.price})` : '未選';
        el.summary.topping.textContent = state.topping ? `${state.topping.name} (+NT$${state.topping.price})` : '無';
        el.summary.ice.textContent = state.ice?.name || '未選';
        el.summary.sugar.textContent = state.sugar ? `${state.sugar.name}${state.sugar.price>0?` (+NT$${state.sugar.price})`:''}` : '無糖';
        el.summary.qty.textContent = state.qty;

        const total = p * state.qty;
        el.price.d.textContent = el.price.m.textContent = `NT$ ${total}`;
        el.cartCount.textContent = cart.length;

        const canNext = (state.step===1 && state.base) || state.step===2 || (state.step===3 && state.ice) || state.step===4;
        const btnText = state.step===4 ? `加入購物車 (${total}元)` : '下一步';
        el.btn.d.textContent = el.btn.m.textContent = btnText;
        el.btn.d.disabled = el.btn.m.disabled = !canNext;
    };

    const select = (card, cat) => {
        const id = card.dataset.id;
        const item = cat==='ice' ? IceOptions.find(x=>x.id===id) : Materials[cat].find(x=>x.id===id);
        document.querySelectorAll(`[data-category="${cat}"]`).forEach(c=>c.classList.remove('selected'));
        if (cat==='topping' && state.topping?.id===id) state.topping = null;
        else {
            card.classList.add('selected');
            state[cat==='ice'?'ice':cat==='base'?'base':cat==='topping'?'topping':'sugar'] = item;
        }
        el.intro.textContent = item.intro;
        updateUI();
    };

    const next = () => state.step===4 ? addToCart() : (state.step++, render());

    const addToCart = () => {
        if (!state.base || !state.ice) return alert('請完成必選項目！');
        cart.push({
            id: Date.now(),
            name: `${state.base.name} (${state.ice.name})`,
            detail: `${state.topping?.name||'無配料'}・${state.sugar?.name||'無糖'}`,
            price: (state.base.price + (state.topping?.price||0) + (state.sugar?.price||0)) * state.qty,
            qty: state.qty
        });
        alert(`已加入 ${state.qty} 杯「${state.base.name}」！`);
        state = { step: 1, qty: 1, base: null, topping: null, ice: null, sugar: null };
        render();
    };

    const render = () => {
        updateUI();
        const map = {1:'base',2:'topping',3:'ice',4:'sweetener'};
        const data = map[state.step]==='ice' ? IceOptions : Materials[map[state.step]];
        const titles = {base:'選擇基底', topping:'添加配料（可略過）', ice:'冰量／溫度', sweetener:'甜度選擇'};

        let html = `<h2 class="text-5xl font-black mb-10 text-stone-800">${titles[map[state.step]]}</h2>`;
        html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-6">';

        data.forEach(item => {
            const selected = state[map[state.step]]?.id === item.id;
            const tag = item.type==='夜酒' ? '夜間限定' : (item.healthy ? '養生嚴選' : '');
            html += `
            <div class="choice-card ${selected?'selected':''}" data-id="${item.id}" data-category="${map[state.step]}">
                <img src="${item.img}" class="material-image" onerror="this.src='https://placehold.co/800x600/064e3b/white?text=仙'">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-2xl font-bold">${item.name}</h3>
                        ${tag?`<span class="text-sm px-4 py-2 rounded-full ${item.type==='夜酒'?'bg-red-100 text-red-700':'bg-emerald-100 text-emerald-700'} font-bold">${tag}</span>`:''}
                    </div>
                    <p class="text-3xl font-black text-emerald-600 mb-3">${item.price>0?'+'+item.price:'標配'}</p>
                    <p class="text-lg text-stone-600 leading-relaxed">${item.intro}</p>
                </div>
            </div>`;
        });
        html += '</div>';

        if (state.step===4) {
            html += `
            <div class="mt-16 bg-gradient-to-br from-emerald-50 to-teal-50 rounded-3xl p-12 text-center">
                <h3 class="text-4xl font-black mb-10">選擇數量</h3>
                <div class="flex items-center justify-center gap-12">
                    <button onclick="state.qty=Math.max(1,state.qty-1);document.getElementById('qty').value=state.qty;updateUI()" class="quantity-btn bg-red-500 hover:bg-red-600 text-white">-</button>
                    <input id="qty" type="number" value="${state.qty}" min="1" class="w-40 text-7xl font-black text-center bg-transparent" onchange="state.qty=Math.max(1,parseInt(this.value)||1);updateUI()">
                    <button onclick="state.qty++;document.getElementById('qty').value=state.qty;updateUI()" class="quantity-btn bg-sky-500 hover:bg-sky-600 text-white">+</button>
                </div>
            </div>`;
            if (!state.sugar) { state.sugar = Materials.sweetener[0]; updateUI(); }
        }

        el.area.innerHTML = html;
        document.querySelectorAll('.choice-card').forEach(c => c.onclick = () => select(c, map[state.step]));
    };

    document.getElementById('view-cart-btn').onclick = () => {
        if (cart.length===0) {
            el.area.innerHTML = `<div class="text-center py-32"><h2 class="text-7xl font-black mb-10">購物車是空的</h2><button onclick="render()" class="bg-emerald-600 text-white px-16 py-8 rounded-full text-4xl hover:bg-emerald-700">開始點餐</button></div>`;
            return;
        }
        const total = cart.reduce((s,i)=>s+i.price,0);
        el.area.innerHTML = `
            <h2 class="text-6xl font-black mb-12">購物車</h2>
            <div class="space-y-6 mb-12">
                ${cart.map(i=>`
                <div class="bg-white rounded-3xl p-8 shadow-2xl flex justify-between items-center">
                    <div>
                        <div class="text-3xl font-black">${i.name} × ${i.qty}</div>
                        <div class="text-xl text-stone-600 mt-2">${i.detail}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-black text-emerald-600">NT$ ${i.price}</div>
                        <button onclick="cart=cart.filter(x=>x.id!==${i.id});updateUI();this.closest('.space-y-6').innerHTML='';document.getElementById('view-cart-btn').click()" class="text-red-500 text-lg mt-3">移除</button>
                    </div>
                </div>`).join('')}
            </div>
            <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-3xl p-12 text-white text-center mb-12">
                <div class="text-5xl font-black mb-4">訂單總金額</div>
                <div class="text-8xl font-black">NT$ ${total}</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <button onclick="render()" class="py-8 bg-stone-700 hover:bg-stone-800 text-white rounded-3xl text-3xl font-black">繼續點餐</button>
                <button onclick="el.area.innerHTML='<div class=\\'text-center py-40\\'><h2 class=\\'text-8xl font-black text-emerald-600 mb-12\\'>訂單完成！</h2><p class=\\'text-5xl mb-16\\'>感謝您的光臨</p><div class=\\'text-9xl font-black text-emerald-700 mb-20\\'>NT$ ${total}</div><button onclick=\\'cart=[];render()\\' class=\\'bg-stone-800 text-white px-20 py-10 rounded-full text-5xl hover:bg-black\\'>再來一單</button></div>';updateUI()" class="py-8 bg-sky-600 hover:bg-sky-700 text-white rounded-3xl text-3xl font-black">立即結帳</button>
            </div>`;
    };

    el.btn.d.onclick = el.btn.m.onclick = next;
    render();
</script>
</body>
</html>
