<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»™ (Xian) - Kioské»é¤æµç¨‹æ¨¡æ“¬ (å±•ç¤ºç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- éŸ¿æ‡‰å¼ä½ˆå±€ç­–ç•¥ï¼šå·²ä¿®æ­£åº•éƒ¨é®æ“‹å•é¡Œã€‚åœ¨æ‰‹æ©Ÿä¸Šï¼Œä¸»å…§å®¹å€å¡Š (main-content-area) å¢åŠ äº† 120px çš„åº•éƒ¨å¡«å……ï¼Œç¢ºä¿å…§å®¹ä¸æœƒè¢«å›ºå®šåº•æ¬„ (mobile-footer) é®è“‹ã€‚ -->
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5f5f4; /* bg-stone-100 */
        }
        /* Kiosk è¢å¹•åœ¨æ¡Œé¢ç‰ˆ (MD+) ä¸Šé™åˆ¶å°ºå¯¸ï¼Œä½†åœ¨æ‰‹æ©Ÿä¸Š (é è¨­) å‰‡ä½”æ»¿è¦–çª— */
        #kiosk-container {
            width: 100%;
            height: 100vh; /* æ‰‹æ©Ÿä½¿ç”¨å…¨é«˜ */
            max-width: 1000px;
            box-shadow: 0 0 0 transparent; /* æ‰‹æ©Ÿä¸Šç§»é™¤é™°å½± */
        }
        @media (min-width: 768px) {
            #kiosk-container {
                height: 90vh; /* æ¡Œé¢é™åˆ¶é«˜åº¦ */
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                border: 4px solid #44403c; /* stone-800 */
                border-radius: 16px;
                overflow: hidden;
            }
        }

        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background-color: #047857; /* emerald-700 */
            color: white;
            transform: scale(1.05);
        }
        .choice-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .choice-card:hover {
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
            transform: translateY(-2px);
        }
        .choice-card.selected {
            border: 3px solid #059669; /* emerald-600 */
            background-color: #ecfdf5; /* emerald-50 */
            transform: scale(1.02);
        }
        .material-image {
            height: 100px; /* å›ºå®šåœ–ç‰‡é«˜åº¦ */
            width: 100%;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        /* éš±è—æ¡Œé¢ç‰ˆçš„ Next/Price å€åŸŸï¼Œå› ç‚ºå®ƒå€‘è¢«ç§»åˆ°å›ºå®šåº•éƒ¨æ¬„ */
        #desktop-footer {
            display: none;
        }
        @media (min-width: 768px) {
            #desktop-footer {
                display: block; /* æ¡Œé¢ç‰ˆé¡¯ç¤ºåœ¨å·¦å´æ¬„åº•éƒ¨ */
            }
            #mobile-footer {
                display: none !important; /* æ¡Œé¢ç‰ˆéš±è—å›ºå®šåº•éƒ¨æ¬„ */
            }
        }
        
        /* æ‰‹æ©Ÿå›ºå®šåº•éƒ¨æ¬„æ¨£å¼ */
        #mobile-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #44403c; /* stone-800 */
            z-index: 50;
            padding: 1rem;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
        }
        /* æ•¸é‡é¸æ“‡å™¨çš„æ¨£å¼ */
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 1rem;
        }
        .quantity-btn {
            background-color: #38bdf8; /* sky-400 */
            color: white;
            padding: 0.5rem 1rem;
            font-size: 1.25rem;
            border-radius: 9999px;
            line-height: 1;
        }
        .quantity-input {
            width: 4rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            border: none;
            background: transparent;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-0 md:p-4">

    <!-- Kiosk ä¸»å®¹å™¨ -->
    <div id="kiosk-container" class="bg-white grid grid-cols-1 md:grid-cols-4 w-full">
        
        <!-- A. æ¡Œé¢ç‰ˆå·¦å´æ¬„ / è¡Œå‹•ç‰ˆé ‚éƒ¨ç¸½çµ (md:col-span-1) -->
        <div id="summary-panel" class="md:col-span-1 bg-stone-800 text-white p-4 md:p-6 flex flex-col order-1 md:order-none max-h-56 md:max-h-full overflow-y-auto">
            <div>
                <div class="flex justify-between items-center mb-4 border-b border-emerald-700 pb-2">
                    <h3 class="text-xl md:text-2xl font-bold text-emerald-400">
                        æ‚¨çš„å®¢è£½åŒ–é£²å“
                    </h3>
                    <button id="view-cart-btn" class="bg-sky-500 hover:bg-sky-600 text-white px-3 py-1 rounded-full text-sm font-semibold transition" onclick="renderCart()">
                        è³¼ç‰©è»Š (<span id="cart-count">0</span>)
                    </button>
                </div>
                
                <!-- ç‰©æ–™ä»‹ç´¹å€ -->
                <div id="material-intro" class="mb-4 md:mb-6 h-auto md:h-36 bg-stone-700 p-3 rounded-lg text-xs md:text-sm transition-all duration-300">
                    <p class="text-emerald-300 font-semibold mb-1">ç‰©æ–™ä»‹ç´¹ï¼š</p>
                    <p class="text-stone-300" id="intro-text">è«‹é»é¸ç‰©æ–™é–‹å§‹è£½ä½œæ‚¨çš„é¤Šç”Ÿç‰¹èª¿ã€‚</p>
                </div>

                <!-- ç•¶å‰è¨‚å–®ç¸½çµ -->
                <div id="current-drink" class="space-y-1 md:space-y-2 text-xs md:text-sm">
                    <p class="text-stone-300"><span class="font-semibold text-emerald-300">åŸºåº•ï¼š</span> <span id="summary-base">æœªé¸</span></p>
                    <p class="text-stone-300"><span class="font-semibold text-emerald-300">é…æ–™ï¼š</span> <span id="summary-topping">æœªé¸</span></p>
                    <p class="text-stone-300"><span class="font-semibold text-emerald-300">å†°é‡/æº«åº¦ï¼š</span> <span id="summary-ice">æœªé¸</span></p>
                    <p class="text-stone-300"><span class="font-semibold text-emerald-300">ç”œåº¦ï¼š</span> <span id="summary-sweetener">ç„¡ç³– (æ¨™é…)</span></p>
                    <p class="text-stone-300"><span class="font-semibold text-emerald-300">æ•¸é‡ï¼š</span> <span id="summary-quantity">1</span> æ¯</p>
                </div>
            </div>
            
            <!-- æ¡Œé¢ç‰ˆåº•éƒ¨å›ºå®šå€ (è¡Œå‹•ç‰ˆæœƒéš±è—ï¼Œæ”¹ç”¨ #mobile-footer) -->
            <div id="desktop-footer" class="mt-4 md:mt-6 pt-4 border-t border-emerald-700">
                <p class="text-xl font-bold flex justify-between items-center">
                    ç¸½è¨ˆé‡‘é¡ï¼š
                    <span id="total-price-desktop" class="text-3xl text-emerald-400">NT$ 0</span>
                </p>
                <button id="next-step-btn-desktop" class="w-full mt-4 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-lg transition duration-300" disabled>
                    ä¸‹ä¸€æ­¥
                </button>
            </div>
        </div>

        <!-- B. ä¸»æ“ä½œå€ (md:col-span-3) -->
        <!-- ä¿®æ­£åº•éƒ¨é®æ“‹ï¼Œå¢åŠ åº•éƒ¨å¡«å…… -->
        <div id="main-content-area" class="md:col-span-3 p-4 md:p-6 flex flex-col order-2 md:order-none overflow-y-auto pb-[120px] md:pb-0">
            
            <!-- å“ç‰Œèˆ‡æ­¥é©ŸæŒ‡ç¤º -->
            <header class="mb-4 md:mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-emerald-700 mb-2 md:mb-3">
                    ä»™ Â· å¼•å°å¼é»é¤
                </h1>
                <div class="flex space-x-2 text-xs font-semibold uppercase">
                    <span id="step-1-ind" class="step-indicator px-3 py-1 rounded-full bg-emerald-700 text-white active">1. åŸºåº•é¸æ“‡</span>
                    <span id="step-2-ind" class="step-indicator px-3 py-1 rounded-full bg-stone-300 text-stone-700">2. é…æ–™æ·»åŠ </span>
                    <span id="step-3-ind" class="step-indicator px-3 py-1 rounded-full bg-stone-300 text-stone-700">3. å†°é‡/æº«åº¦</span>
                    <span id="step-4-ind" class="step-indicator px-3 py-1 rounded-full bg-stone-300 text-stone-700">4. ç”œåº¦æ±ºå®š</span>
                </div>
            </header>

            <!-- é¸æ“‡å…§å®¹å€ -->
            <div id="selection-area" class="flex-grow">
                <!-- Content will be dynamically injected here -->
            </div>

        </div>

    </div>
    
    <!-- C. è¡Œå‹•ç‰ˆå›ºå®šåº•éƒ¨æ¬„ (æ‰‹æ©Ÿå°ˆç”¨) -->
    <div id="mobile-footer" class="md:hidden">
        <p class="text-lg font-bold flex justify-between items-center text-white">
            ç¸½è¨ˆé‡‘é¡ï¼š
            <span id="total-price-mobile" class="text-2xl text-emerald-400">NT$ 0</span>
        </p>
        <button id="next-step-btn-mobile" class="w-full mt-3 py-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-lg transition duration-300" disabled>
            ä¸‹ä¸€æ­¥
        </button>
    </div>

    <script>
        // æ ¸å¿ƒç‰©æ–™æ•¸æ“šåº« (å·²å°‡åœ–ç‰‡å°ºå¯¸èª¿æ•´ç‚ºå»ºè­°çš„ 800x600)
        const Materials = {
            base: [
                { id: 'jasmine', name: 'èŒ‰è‰ç¶ èŒ¶', price: 60, intro: 'æ¸…æ–°å›ç”˜ï¼Œå¹«åŠ©æç¥ã€‚ç´”å¤©ç„¶èŒ¶è‘‰æ²–æ³¡ï¼Œé©åˆæ—¥é–“é£²ç”¨ã€‚', type: 'æ—¥èŒ¶', imageUrl: './images/jasmine.jpg' },
                { id: 'oolong', name: 'é«˜å±±çƒé¾', price: 65, intro: 'å£æ„Ÿé†‡åšï¼Œå¯Œå«èŒ¶å¤šé…šï¼Œæœ‰åŠ©æ¶ˆè„‚è§£è†©ã€‚', type: 'æ—¥èŒ¶', imageUrl: './images/oolong.jpg' },
                { id: 'sparkling', name: 'æ°£æ³¡æ°´', price: 70, intro: 'é›¶ç†±é‡ã€é›¶è² æ“”çš„æ¸…çˆ½åŸºåº•ï¼Œä¿ƒé€²é«”å…§å¾ªç’°ï¼Œä¿æŒæ´»åŠ›ã€‚', type: 'æ—¥èŒ¶', imageUrl: './images/sparklingwater.jpg' },
                { id: 'plum_wine', name: 'é¤Šç”Ÿæ¢…é…’', price: 150, intro: 'å¤œé–“å°ˆä¾›ã€‚ä½åº¦æ•¸èª¿é£²ï¼Œæœ‰åŠ©æ–¼èˆ’ç·©èº«å¿ƒï¼Œå¾®é†ºé¤Šé¡ã€‚', type: 'å¤œé…’', imageUrl: './images/umeshu.jpg' },
            ],
            topping: [
                { id: 'ginseng', name: 'äººè”˜ç‰‡', price: 30, intro: 'çè²´é¤Šç”Ÿé…æ–™ï¼Œæœ‰åŠ©æå‡å…ƒæ°£ï¼Œæ»‹è£œå¼·èº«ã€‚', is_healthy: true, imageUrl: './images/inseng.jpg' },
                { id: 'red_date', name: 'ç´…æ£—', price: 20, intro: 'å¤©ç„¶ç”˜ç”œï¼Œå‚³çµ±é¤Šç”Ÿé…æ–¹ï¼Œèƒ½é¤Šè¡€å®‰ç¥ã€‚', is_healthy: true, imageUrl: './images/jujube.jpg' },
                { id: 'pearl', name: 'æ‰‹å·¥çç ', price: 10, intro: 'å°‘é‡ä¾›æ‡‰çš„ç¶“å…¸å£æ„Ÿï¼Œæ¯æ—¥æ–°é®®ç†¬ç…®ï¼Œå»ºè­°æ¸›é‡æ·»åŠ ã€‚', is_healthy: false, imageUrl: './images/boba.jpg' },
                { id: 'aloe', name: 'è˜†è–ˆä¸', price: 15, intro: 'ä½å¡é£½è¶³ï¼Œå¹«åŠ©æ¶ˆåŒ–ï¼Œå£æ„Ÿæ¸…è„†æ»‘é †ã€‚', is_healthy: true, imageUrl: './images/aloe.jpg' },
            ],
            sweetener: [
                { id: 'none', name: 'ç„¡ç³– (æ¨™é…)', price: 0, intro: 'ä¿æŒé£²å“ç´”ç²¹é¢¨å‘³ï¼Œæ˜¯ã€Œä»™ã€å“ç‰Œçš„é è¨­å¥åº·é¸é …ã€‚', pay_for_sugar: false, imageUrl: 'https://placehold.co/800x600/cbd5e1/475569?text=ç„¡ç³–+æ¨™æº–å¥åº·' },
                { id: 'honey', name: 'å¤©ç„¶èœ‚èœœ', price: 15, intro: 'ä»˜è²»é¸é …ã€‚å¤©ç„¶ç”œå‘³åŠ‘ï¼Œå¯Œå«ç¶­ç”Ÿç´ ï¼Œæ¨è–¦çµ¦å¾®å¥¢äº«å—è€…ã€‚', pay_for_sugar: true, imageUrl: './images/honey.jpg' },
                { id: 'cane_sugar', name: 'æ‰‹ç‚’è”—ç³–', price: 10, intro: 'ä»˜è²»é¸é …ã€‚å‚³çµ±å·¥è—ç†¬è£½ï¼Œå¢åŠ é£²å“å±¤æ¬¡æ„Ÿï¼Œä½†è«‹ç•™æ„ç†±é‡ã€‚', pay_for_sugar: true, imageUrl: './images/sucrose.jpg' },
            ]
        };
        // å†°é‡/æº«åº¦é¸é …
        const IceOptions = [
            { id: 'hot', name: 'ç†±é£²', price: 0, intro: 'é©åˆå†¬å­£ï¼Œæä¾›ç†±é£²é¸æ“‡ã€‚' },
            { id: 'warm', name: 'æº«', price: 0, intro: 'æº«é£²ï¼Œæº«åº¦é©ä¸­ã€‚' },
            { id: 'less', name: 'å°‘å†°', price: 0, intro: 'å°‘å†°ï¼Œå†°å¡Šé‡æ¸›å°‘ï¼Œé©åˆä¸å–œæ­¡å¤ªå†°çš„äººã€‚' },
            { id: 'micro', name: 'å¾®å†°', price: 0, intro: 'å¾®å†°ï¼Œå¹¾ä¹æ²’å†°å¡Šï¼Œé©åˆä¿å­˜åŸå‘³ã€‚' },
            { id: 'normal', name: 'æ­£å¸¸å†°', price: 0, intro: 'æ­£å¸¸å†°ï¼Œç¶“å…¸å†°å¡Šé‡ï¼Œå†°æ¶¼æš¢å¿«ã€‚' },
        ];
        Materials.ice = IceOptions; // åŠ å…¥å†°é¸é …åˆ°è³‡æ–™åº«

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (State)
        let shoppingCart = []; // å„²å­˜å·²åŠ å…¥è³¼ç‰©è»Šçš„å“é …
        let currentState = {
            step: 1,
            quantity: 1, // é è¨­æ•¸é‡ç‚º 1
            selectedBase: null,
            selectedTopping: null,
            selectedIce: null,
            selectedSweetener: null,
            totalPrice: 0 // å–®æ¯å–®åƒ¹
        };

        // DOM å…ƒç´ å¼•ç”¨
        const selectionArea = document.getElementById('selection-area');
        
        // æ¡Œé¢ç‰ˆæŒ‰éˆ•/åƒ¹æ ¼
        const nextStepBtnDesktop = document.getElementById('next-step-btn-desktop');
        const totalPriceElDesktop = document.getElementById('total-price-desktop');
        
        // è¡Œå‹•ç‰ˆæŒ‰éˆ•/åƒ¹æ ¼
        const nextStepBtnMobile = document.getElementById('next-step-btn-mobile');
        const totalPriceElMobile = document.getElementById('total-price-mobile');

        const introTextEl = document.getElementById('intro-text');
        
        // ç¸½çµé¢æ¿
        const summaryBase = document.getElementById('summary-base');
        const summaryTopping = document.getElementById('summary-topping');
        const summaryIce = document.getElementById('summary-ice');
        const summarySweetener = document.getElementById('summary-sweetener');
        const summaryQuantity = document.getElementById('summary-quantity');
        const cartCountEl = document.getElementById('cart-count');

        // æ­¥é©ŸæŒ‡ç¤ºå™¨ (4æ­¥)
        const stepIndicators = [
            document.getElementById('step-1-ind'),
            document.getElementById('step-2-ind'),
            document.getElementById('step-3-ind'),
            document.getElementById('step-4-ind')
        ];

        // --- æ ¸å¿ƒé‚è¼¯å‡½æ•¸ ---

        /**
         * æ ¹æ“šç•¶å‰ç‹€æ…‹æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨å¤–è§€
         */
        function updateStepIndicators() {
            stepIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'bg-emerald-700', 'text-white');
                indicator.classList.add('bg-stone-300', 'text-stone-700');
                if (index + 1 === currentState.step) {
                    indicator.classList.add('active');
                }
                // å·²å®Œæˆçš„æ­¥é©Ÿé¡è‰²è¦å›ºå®š
                if (index + 1 < currentState.step) {
                    indicator.classList.remove('bg-stone-300', 'text-stone-700');
                    indicator.classList.add('bg-emerald-800', 'text-white');
                }
            });
        }

        /**
         * æ›´æ–°è¨‚å–®ç¸½çµèˆ‡åƒ¹æ ¼
         */
        function updateSummary() {
            currentState.totalPrice = 0;
            
            if (currentState.selectedBase) {
                currentState.totalPrice += currentState.selectedBase.price;
                summaryBase.textContent = `${currentState.selectedBase.name} (NT$ ${currentState.selectedBase.price})`;
            } else {
                summaryBase.textContent = 'æœªé¸';
            }

            if (currentState.selectedTopping) {
                currentState.totalPrice += currentState.selectedTopping.price;
                summaryTopping.textContent = `${currentState.selectedTopping.name} (+NT$ ${currentState.selectedTopping.price})`;
            } else {
                summaryTopping.textContent = 'æœªé¸';
            }

            if (currentState.selectedIce) {
                // å†°å¡Šä¸åŠ åƒ¹
                summaryIce.textContent = currentState.selectedIce.name;
            } else {
                summaryIce.textContent = 'æœªé¸';
            }

            if (currentState.selectedSweetener) {
                currentState.totalPrice += currentState.selectedSweetener.price;
                summarySweetener.textContent = `${currentState.selectedSweetener.name} ${currentState.selectedSweetener.price > 0? '(+NT$ ' + currentState.selectedSweetener.price + ')' : ''}`;
            } else {
                summarySweetener.textContent = 'ç„¡ç³– (æ¨™é…)';
            }
            
            summaryQuantity.textContent = currentState.quantity;
            const finalPrice = currentState.totalPrice * currentState.quantity;
            const priceText = `NT$ ${finalPrice}`;
            totalPriceElDesktop.textContent = priceText;
            totalPriceElMobile.textContent = priceText;

            // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡é¡¯ç¤º
            cartCountEl.textContent = shoppingCart.length;

            // æª¢æŸ¥æ˜¯å¦å¯ä»¥é€²å…¥ä¸‹ä¸€æ­¥
            let canProceed = false;
            if (currentState.step === 1 && currentState.selectedBase) {
                canProceed = true;
            } else if (currentState.step === 2) {
                canProceed = true; // é…æ–™å¯é¸å¯ä¸é¸
            } else if (currentState.step === 3 && currentState.selectedIce) {
                canProceed = true;
            } else if (currentState.step === 4 && currentState.selectedSweetener) {
                canProceed = true;
            }
            
            const btnText = currentState.step === 4? `åŠ å…¥è³¼ç‰©è»Š (å…±${finalPrice}å…ƒ)` : 'ä¸‹ä¸€æ­¥';
            
            nextStepBtnDesktop.disabled = !canProceed;
            nextStepBtnDesktop.textContent = btnText;
            
            nextStepBtnMobile.disabled = !canProceed;
            nextStepBtnMobile.textContent = btnText;
        }

        /**
         * è™•ç†ç‰©æ–™é¸æ“‡ (base, topping, ice, sweetener)
         */
        function handleSelection(card, category) {
            const itemId = card.getAttribute('data-id');
            let item;
            if (category === 'ice') {
                item = IceOptions.find(i => i.id === itemId);
            } else {
                item = Materials[category].find(i => i.id === itemId);
            }

            // æ¸…é™¤ç•¶å‰åˆ†é¡çš„é¸æ“‡
            selectionArea.querySelectorAll(`.choice-card[data-category="${category}"]`).forEach(c => c.classList.remove('selected'));
            
            // è¨­å®šæ–°çš„é¸æ“‡
            card.classList.add('selected');

            switch (category) {
                case 'base':
                    currentState.selectedBase = item;
                    break;
                case 'topping':
                    if (currentState.selectedTopping && currentState.selectedTopping.id === item.id) {
                         currentState.selectedTopping = null;
                         card.classList.remove('selected');
                    } else {
                         currentState.selectedTopping = item;
                    }
                    break;
                case 'ice':
                    currentState.selectedIce = item;
                    break;
                case 'sweetener':
                    currentState.selectedSweetener = item;
                    break;
            }

            // å›ºå®šé¡¯ç¤ºä»‹ç´¹
            introTextEl.textContent = item.intro;
            
            updateSummary();
        }

        /**
         * è™•ç†æ»‘é¼ æ‡¸åœé¡¯ç¤ºç‰©æ–™ä»‹ç´¹ (æ•™è‚²æ€§å¼•å°)
         */
        function displayIntro(card, category) {
            const itemId = card.getAttribute('data-id');
            let item;
            if (category === 'ice') {
                item = IceOptions.find(i => i.id === itemId);
            } else {
                item = Materials[category].find(i => i.id === itemId);
            }
            if (item) {
                introTextEl.textContent = item.intro;
            }
        }

        /**
         * æ¸…é™¤ä»‹ç´¹ï¼Œå›åˆ°å·²é¸æ“‡é …ç›®çš„ç¸½çµ
         */
        function clearIntro() {
             if (currentState.step === 1 && currentState.selectedBase) {
                introTextEl.textContent = currentState.selectedBase.intro;
            } else if (currentState.step === 2 && currentState.selectedTopping) {
                introTextEl.textContent = currentState.selectedTopping.intro;
            } else if (currentState.step === 3 && currentState.selectedIce) {
                introTextEl.textContent = currentState.selectedIce.intro;
            } else if (currentState.step === 4 && currentState.selectedSweetener) {
                introTextEl.textContent = currentState.selectedSweetener.intro;
            } else {
                introTextEl.textContent = 'è«‹é»é¸ç‰©æ–™é–‹å§‹è£½ä½œæ‚¨çš„é¤Šç”Ÿç‰¹èª¿ã€‚';
            }
        }

        /**
         * æ›´æ–°å–®å“æ•¸é‡
         */
        function updateQuantity(delta) {
            const newQuantity = currentState.quantity + delta;
            if (newQuantity >= 1) {
                currentState.quantity = newQuantity;
                const inputEl = document.getElementById('drink-quantity-input');
                if (inputEl) inputEl.value = newQuantity;
                updateSummary();
            }
        }
        
        function updateQuantityInput(value) {
            const newQuantity = parseInt(value);
            if (!isNaN(newQuantity) && newQuantity >= 1) {
                currentState.quantity = newQuantity;
            } else {
                currentState.quantity = 1;
            }
            updateSummary();
        }

        /**
         * æ¨é€²æ­¥é©Ÿæˆ–åŠ å…¥è³¼ç‰©è»Š
         */
        function nextStep() {
            if (currentState.step === 4) {
                addToCart();
            } else {
                currentState.step += 1;
                updateKioskView();
            }
        }
        
        /**
         * å°‡ç•¶å‰å®¢è£½åŒ–é£²å“åŠ å…¥è³¼ç‰©è»Š
         */
        function addToCart() {
            if (!currentState.selectedBase || !currentState.selectedIce || !currentState.selectedSweetener) {
                alert("è«‹å®ŒæˆåŸºåº•ã€å†°é‡/æº«åº¦å’Œç”œåº¦é¸æ“‡ï¼");
                return;
            }
            
            const itemName = `${currentState.selectedBase.name} (${currentState.selectedIce.name}/${currentState.selectedSweetener.name})`;
            const item = {
                id: Date.now(),
                name: itemName,
                base: currentState.selectedBase.name,
                topping: currentState.selectedTopping? currentState.selectedTopping.name : 'ç„¡',
                ice: currentState.selectedIce.name,
                sweetener: currentState.selectedSweetener.name,
                unitPrice: currentState.totalPrice,
                quantity: currentState.quantity,
                totalPrice: currentState.totalPrice * currentState.quantity
            };
            
            shoppingCart.push(item);
            
            // é‡ç½®é¸æ“‡ç‹€æ…‹ (ä¿ç•™è³¼ç‰©è»Š)
            currentState = {
                step: 1,
                quantity: 1,
                selectedBase: null,
                selectedTopping: null,
                selectedIce: null,
                selectedSweetener: null,
                totalPrice: 0
            };
            introTextEl.textContent = 'è«‹é»é¸ç‰©æ–™é–‹å§‹è£½ä½œæ‚¨çš„é¤Šç”Ÿç‰¹èª¿ã€‚';
            updateKioskView(); // å›åˆ°æ­¥é©Ÿ1

            alert(`å·²å°‡ ${item.quantity} æ¯ ${item.name} åŠ å…¥è³¼ç‰©è»Šï¼`);
            renderCart(); // é¡¯ç¤ºè³¼ç‰©è»Š
        }

        /**
         * æ¸²æŸ“è³¼ç‰©è»Šæª¢è¦–/çµå¸³ç•«é¢
         */
        function renderCart() {
            if (shoppingCart.length === 0) {
                 selectionArea.innerHTML = `
                    <div class="text-center p-8 md:p-12 bg-stone-50 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold text-stone-900 mb-4">ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„</h2>
                        <p class="text-lg text-stone-700 mb-6">è«‹å…ˆå®¢è£½åŒ–æ‚¨çš„ç¬¬ä¸€æ¯é¤Šç”Ÿç‰¹èª¿ï¼</p>
                        <div class="mt-8">
                            <button onclick="resetKiosk()" class="bg-emerald-600 text-white px-6 py-3 rounded-full hover:bg-emerald-700 transition">é–‹å§‹é»é¤</button>
                        </div>
                    </div>
                `;
                nextStepBtnDesktop.disabled = true;
                nextStepBtnMobile.disabled = true;
                return;
            }
            
            let totalCartPrice = shoppingCart.reduce((sum, item) => sum + item.totalPrice, 0);
            
            let cartItemsHTML = shoppingCart.map(item => `
                <div class="flex justify-between items-center py-3 border-b border-stone-200">
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${item.name} x ${item.quantity}</p>
                        <p class="text-sm text-stone-500">é…æ–™: ${item.topping} | å–®åƒ¹: NT$ ${item.unitPrice}</p>
                    </div>
                    <p class="font-bold text-xl text-emerald-600">NT$ ${item.totalPrice}</p>
                    <button class="text-red-500 ml-4 hover:text-red-700" onclick="removeItemFromCart(${item.id})">
                        X
                    </button>
                </div>
            `).join('');

            selectionArea.innerHTML = `
                <h2 class="text-3xl md:text-4xl font-bold text-stone-900 mb-6">ğŸ›’ è³¼ç‰©è»Šæª¢è¦–èˆ‡çµå¸³</h2>
                <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-6">
                    ${cartItemsHTML}
                </div>
                
                <div class="flex justify-between items-center bg-emerald-50 p-4 md:p-6 rounded-xl shadow-xl">
                    <p class="text-2xl font-bold text-stone-900">è¨‚å–®ç¸½é‡‘é¡ï¼š</p>
                    <p class="text-3xl font-extrabold text-emerald-700">NT$ ${totalCartPrice}</p>
                </div>

                <div class="mt-8 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                    <button onclick="resetKiosk()" class="w-full md:w-1/2 py-3 rounded-lg bg-stone-600 hover:bg-stone-700 text-white font-bold text-lg transition duration-300">
                        ç¹¼çºŒé»é¤ (å›æ­¥é©Ÿ 1)
                    </button>
                    <button onclick="finishCheckout()" class="w-full md:w-1/2 py-3 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-bold text-lg transition duration-300">
                        ç¢ºèªæ”¯ä»˜ NT$ ${totalCartPrice}
                    </button>
                </div>
            `;
            nextStepBtnDesktop.disabled = true;
            nextStepBtnMobile.disabled = true;
        }

        /**
         * å¾è³¼ç‰©è»Šç§»é™¤å–®ä¸€å“é …
         */
        function removeItemFromCart(id) {
            shoppingCart = shoppingCart.filter(item => item.id !== id);
            updateSummary();
            renderCart(); // é‡æ–°æ¸²æŸ“è³¼ç‰©è»Š
        }
        
        /**
         * å®Œæˆçµå¸³
         */
        function finishCheckout() {
            const finalTotal = shoppingCart.reduce((sum, item) => sum + item.totalPrice, 0);
            selectionArea.innerHTML = `
                <div class="text-center p-8 md:p-12 bg-emerald-50 rounded-xl shadow-lg">
                    <h2 class="text-4xl font-bold text-emerald-700 mb-4">ğŸ‰ äº¤æ˜“æˆåŠŸï¼</h2>
                    <p class="text-xl text-stone-700 mb-6">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼ç¸½é‡‘é¡ï¼š<span class="text-3xl font-extrabold text-emerald-600">NT$ ${finalTotal}</span></p>
                    <p class="text-stone-600">æ‚¨çš„è¨‚å–®å·²é€å¾€è£½å‚™å€ã€‚è«‹ç¨å€™ï¼Œæ‚¨çš„é¤Šç”Ÿç‰¹èª¿å³å°‡å®Œæˆï¼</p>
                    <div class="mt-8">
                        <button onclick="resetKiosk()" class="bg-stone-700 text-white px-6 py-3 rounded-full hover:bg-stone-900 transition">é–‹å§‹æ–°è¨‚å–®</button>
                    </div>
                </div>
            `;
            shoppingCart = []; // æ¸…ç©ºè³¼ç‰©è»Š
            updateSummary();
            nextStepBtnDesktop.disabled = true;
            nextStepBtnMobile.disabled = true;
        }

        /**
         * æ ¹æ“šç•¶å‰æ­¥é©Ÿæ¸²æŸ“ç•«é¢
         */
        function updateKioskView() {
            updateStepIndicators();
            updateSummary();

            switch (currentState.step) {
                case 1:
                    renderOptions('base');
                    break;
                case 2:
                    renderOptions('topping');
                    break;
                case 3:
                    renderOptions('ice');
                    break;
                case 4:
                    renderOptions('sweetener');
                    // è‹¥æœªé¸ç”œåº¦ï¼Œé è¨­ç„¡ç³–
                    if (!currentState.selectedSweetener) {
                        currentState.selectedSweetener = Materials.sweetener.find(i => i.id === 'none');
                        updateSummary();
                    }
                    break;
            }
        }

        /**
         * æ¸²æŸ“é¸é …å¡ç‰‡
         * @param {string} category - base, topping, ice, or sweetener
         */
        function renderOptions(category) {
            selectionArea.innerHTML = '';
            const data = (category === 'ice' ? IceOptions : Materials[category]);
            
            const titleMap = {
                base: '1. é¸æ“‡é£²å“åŸºåº•',
                topping: '2. æŒ‘é¸é¤Šç”Ÿé…æ–™ (å¯é¸å¯ä¸é¸)',
                ice: '3. æ±ºå®šå†°é‡/æº«åº¦',
                sweetener: '4. æ±ºå®šé£²å“ç”œåº¦'
            };
            const subtitleMap = {
                base: 'ï¼ˆèŒ¶ã€æœæ±ã€æ°£æ³¡æ°´æˆ–å¤œé–“é™å®šé…’å“ï¼‰',
                topping: 'ï¼ˆäººè”˜ã€ç´…æ£—ç­‰é«˜åƒ¹å€¼é…æ–™ï¼Œé»é¸æŸ¥çœ‹åŠŸæ•ˆï¼‰',
                ice: 'ï¼ˆç†±é£²ã€å¸¸æº«æˆ–å†°å¡Šé‡é¸é …ï¼‰',
                sweetener: 'ï¼ˆã€Œç„¡ç³–ã€æ˜¯æ¨™é…ï¼ŒåŠ ç³–éœ€ä»˜è²»å®¢è£½åŒ–ï¼‰'
            };
            
            const cardGridClass = 'grid grid-cols-2 lg:grid-cols-4 gap-4 pb-4'; 

            const headerHTML = `
                <h2 class="text-2xl md:text-3xl font-bold text-stone-900">${titleMap[category]}</h2>
                <p class="text-stone-600 mb-4 md:mb-6">${subtitleMap[category]}</p>
                <div class="${cardGridClass}">
            `;
            
            let cardsHTML = '';
            data.forEach(item => {
                const selectedClass = (category === 'base' && currentState.selectedBase && currentState.selectedBase.id === item.id) ||
                                      (category === 'topping' && currentState.selectedTopping && currentState.selectedTopping.id === item.id) ||
                                      (category === 'ice' && currentState.selectedIce && currentState.selectedIce.id === item.id) ||
                                      (category === 'sweetener' && currentState.selectedSweetener && currentState.selectedSweetener.id === item.id)
                                      ? 'selected' : '';

                const priceText = item.price > 0 ? `+NT$ ${item.price}` : (category === 'sweetener' ? 'NT$ 0' : '');
                const extraTag = item.type === 'å¤œé…’' ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">å¤œé–“é™å®š</span>' : (item.is_healthy ? '<span class="text-xs bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full">é¤Šç”Ÿåš´é¸</span>' : '');

                cardsHTML += `
                    <div class="choice-card p-3 border border-stone-300 rounded-xl bg-white shadow-sm flex flex-col h-full ${selectedClass}" data-id="${item.id}" data-category="${category}">
                        <!-- åœ–ç‰‡éƒ¨åˆ†ï¼šå»ºè­°ä½¿ç”¨ 800x600 çš„å¯¦æ‹åœ– -->
                        <img src="${item.imageUrl || 'https://placehold.co/800x600?text=åœ–ç‰‡'}" alt="${item.name} ç¤ºæ„åœ–" class="material-image rounded-md mb-2" 
                             onerror="this.onerror=null;this.src='https://placehold.co/400x100/e0f2f1/064e3b?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—'" />
                        
                        <!-- æ–‡å­—è³‡è¨Šéƒ¨åˆ† -->
                        <div class="flex flex-col flex-grow">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="text-base md:text-lg font-semibold text-stone-900">${item.name}</h3>
                                ${extraTag}
                            </div>
                            <p class="text-base md:text-lg font-bold text-emerald-600">${priceText}</p>
                            <p class="text-xs md:text-sm text-stone-500 mt-1 flex-grow">${item.intro.split('ï¼Œ')[0]}...</p>
                        </div>
                    </div>
                `;
            });

            selectionArea.innerHTML = headerHTML + cardsHTML + '</div>';
            
            // åŠ å…¥ã€Œæ•¸é‡é¸æ“‡ã€å€å¡Š (åƒ…åœ¨ç”œåº¦æ­¥é©Ÿ)
            if (category === 'sweetener') {
                selectionArea.innerHTML += `
                    <div class="mt-8 pt-4 border-t border-stone-300">
                        <h2 class="text-2xl font-bold text-stone-900 mb-4">5. é¸æ“‡æ•¸é‡</h2>
                        <div class="quantity-control">
                            <button class="quantity-btn bg-red-400 hover:bg-red-500" onclick="updateQuantity(-1)" ${currentState.quantity === 1 ? 'disabled' : ''}>-</button>
                            <input id="drink-quantity-input" type="number" min="1" max="99" value="${currentState.quantity}" class="quantity-input mx-4" onchange="updateQuantityInput(this.value)">
                            <button class="quantity-btn bg-sky-400 hover:bg-sky-500" onclick="updateQuantity(1)">+</button>
                        </div>
                    </div>
                `;
            }

            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            selectionArea.querySelectorAll('.choice-card').forEach(card => {
                card.addEventListener('click', () => handleSelection(card, category));
                card.addEventListener('mouseover', () => displayIntro(card, category));
                card.addEventListener('mouseout', () => clearIntro());
            });

            // é¦–æ¬¡æ¸²æŸ“æ™‚ï¼Œå¦‚æœå·²ç¶“æœ‰é¸æ“‡ï¼Œå‰‡é¡¯ç¤ºå…¶ä»‹ç´¹
            if (category === 'base' && currentState.selectedBase) {
                introTextEl.textContent = currentState.selectedBase.intro;
            } else if (category === 'topping' && currentState.selectedTopping) {
                 introTextEl.textContent = currentState.selectedTopping.intro;
            } else if (category === 'ice' && currentState.selectedIce) {
                 introTextEl.textContent = currentState.selectedIce.intro;
            } else if (category === 'sweetener' && currentState.selectedSweetener) {
                 introTextEl.textContent = currentState.selectedSweetener.intro;
            }
        }

        /**
         * å•Ÿå‹•æ–°è¨‚å–® (é‡è¨­æ‰€æœ‰ç‹€æ…‹ä¸¦å›åˆ° Step 1)
         */
        function resetKiosk() {
             shoppingCart = [];
             currentState = {
                step: 1,
                quantity: 1,
                selectedBase: null,
                selectedTopping: null,
                selectedIce: null,
                selectedSweetener: null,
                totalPrice: 0
            };
            introTextEl.textContent = 'è«‹é»é¸ç‰©æ–™é–‹å§‹è£½ä½œæ‚¨çš„é¤Šç”Ÿç‰¹èª¿ã€‚';
            updateKioskView();
        }

        // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ ---
        
        nextStepBtnDesktop.addEventListener('click', nextStep);
        nextStepBtnMobile.addEventListener('click', nextStep);
        
        updateKioskView(); // å•Ÿå‹• Kiosk
    </script>
</body>
</html>
